<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>æ¯•åŠ ç´¢æ—¥è®° Â· å¯çˆ±å¡è·¯é‡Œ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', system-ui, sans-serif;
            background: #f9f7f3;
            color: #4a4a4a;
            max-width: 600px;
            margin: 0 auto;
            padding: 16px 12px 24px;
            min-height: 100vh;
        }
        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .app-icon {
            font-size: 32px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.05));
        }
        .app-title {
            font-size: 22px;
            font-weight: 600;
            color: #e9a6a6;
            letter-spacing: 1px;
        }
        .calendar-icon {
            font-size: 28px;
            background: white;
            width: 48px;
            height: 48px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(233,166,166,0.2);
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #ffe3e3;
        }
        .calendar-icon:hover {
            background: #fff1f0;
        }
        /* çƒ­é‡å¡ç‰‡ & æ‹ç…§æŒ‰é’® */
        .calorie-card {
            background: white;
            border-radius: 40px;
            padding: 24px 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 16px rgba(245, 205, 205, 0.3);
            border: 1px solid #ffd9d9;
            transition: background-color 0.3s;
        }
        .total-cal {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }
        .total-cal span {
            font-size: 16px;
            font-weight: 400;
            color: #888;
        }
        .warning-badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 12px;
            display: inline-block;
            transition: all 0.3s;
        }
        /* å¡è·¯é‡Œé¢œè‰²çŠ¶æ€ */
        .calorie-card.green {
            background: #e8f5e9;
            border-color: #a5d6a5;
        }
        .calorie-card.yellow {
            background: #fff9e6;
            border-color: #ffe082;
        }
        .calorie-card.red {
            background: #ffebee;
            border-color: #ef9a9a;
        }
        .green .total-cal {
            color: #2e7d32;
        }
        .yellow .total-cal {
            color: #b26a00;
        }
        .red .total-cal {
            color: #b71c1c;
        }
        .camera-btn {
            background: #ffeaa5;
            border: 2px dashed #f3b5b5;
            border-radius: 60px;
            padding: 18px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 600;
            color: #9b6b6b;
            margin: 18px 0 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .camera-btn:hover {
            background: #ffe494;
        }
        /* é£Ÿç‰©åˆ—è¡¨ */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0 12px;
            color: #a76e6e;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .food-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .food-item {
            background: white;
            border-radius: 28px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
            border: 1px solid #ffe0e0;
            transition: 0.15s;
            cursor: pointer;
        }
        .food-item:active {
            background: #fff5f5;
        }
        .food-img {
            width: 70px;
            height: 70px;
            border-radius: 30px;
            background: #f0e3e3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            color: #ad7a7a;
            object-fit: cover;
            border: 2px solid #ffd9d9;
        }
        .food-info {
            flex: 1;
        }
        .food-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .food-cal {
            font-size: 14px;
            color: #b97777;
            background: #ffeeee;
            padding: 2px 12px;
            border-radius: 30px;
            display: inline-block;
        }
        .food-remark {
            font-size: 13px;
            color: #9f9f9f;
            margin-top: 4px;
        }
        .delete-btn {
            font-size: 22px;
            background: none;
            border: none;
            padding: 8px 12px;
            color: #dbb0b0;
            cursor: pointer;
            border-radius: 30px;
        }
        .delete-btn:hover {
            background: #ffe2e2;
            color: #c06b6b;
        }
        /* å¼¹çª—èƒŒæ™¯ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white;
            width: 92%;
            max-width: 480px;
            border-radius: 48px;
            padding: 24px 20px;
            box-shadow: 0 20px 40px rgba(161, 93, 93, 0.25);
            border: 2px solid #ffc9c9;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #c47a7a;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .input-field {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #ffdbdb;
            border-radius: 60px;
            font-size: 16px;
            margin-bottom: 18px;
            background: #fffcfc;
        }
        .row-2col {
            display: flex;
            gap: 12px;
        }
        .row-2col > * {
            flex: 1;
        }
        .food-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
            max-height: 220px;
            overflow-y: auto;
            background: #fff3f3;
            padding: 16px 10px;
            border-radius: 40px;
        }
        .food-tag {
            background: white;
            border: 1px solid #ffbebe;
            border-radius: 50px;
            padding: 8px 4px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #a35151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .food-tag.selected {
            background: #fccbcb;
            border-color: #c87878;
            color: #752b2b;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        .btn {
            flex: 1;
            padding: 16px 0;
            border-radius: 60px;
            border: none;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background: #fccbcb;
            color: #773e3e;
            border: 1px solid #eaa6a6;
        }
        .btn-secondary {
            background: white;
            border: 1px solid #d4b6b6;
            color: #8a5e5e;
        }
        .btn-small {
            padding: 10px 20px;
            font-size: 15px;
            background: #ffe3e3;
            border-radius: 40px;
            border: 1px solid #ffb6b6;
            cursor: pointer;
            margin: 8px 0;
        }
        .category-title {
            font-weight: 600;
            margin: 10px 0 5px;
            color: #b28282;
            font-size: 16px;
        }
        .confirm-box {
            text-align: center;
            padding: 20px 0;
        }
        .hidden {
            display: none;
        }
        
        /* æ—¥å†æ ·å¼ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 15px;
        }
        .calendar-month {
            font-size: 22px;
            font-weight: 600;
            color: #b15e5e;
        }
        .calendar-nav-btn {
            background: #ffe3e3;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 30px;
            font-size: 20px;
            cursor: pointer;
            color: #a76e6e;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
            color: #b28282;
            font-weight: 500;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff5f5;
            border-radius: 18px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ffd9d9;
            padding: 4px;
        }
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        .calendar-day.selected {
            border: 3px solid #f3b5b5;
            background: #ffe9e9;
        }
        .day-number {
            font-weight: 600;
            color: #8a5e5e;
        }
        .day-calories {
            font-size: 10px;
            color: #b97777;
            background: white;
            padding: 2px 6px;
            border-radius: 20px;
            margin-top: 2px;
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* ä¸åŒçƒ­é‡çº§åˆ«çš„èƒŒæ™¯è‰² */
        .calendar-day.cal-low {
            background: #e8f5e9;
        }
        .calendar-day.cal-mid {
            background: #fff9e6;
        }
        .calendar-day.cal-high {
            background: #ffebee;
        }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨ -->
<div class="header">
    <div class="header-left">
        <span class="app-icon">ğŸ¥•ğŸ¨</span>
        <span class="app-title">æ¯•åŠ ç´¢æ—¥è®°</span>
    </div>
    <div class="calendar-icon" id="calendarBtn" title="æŸ¥çœ‹æ—¥å†">ğŸ“…</div>
</div>

<!-- çƒ­é‡å¡ç‰‡ & æ‹ç…§ -->
<div class="calorie-card green" id="calorieCard">
    <div class="total-cal" id="totalCalDisplay">
        0 å¤§å¡
        <span>ç›®æ ‡1500</span>
    </div>
    <div class="warning-badge" id="warningMessage">âœ¨ è¿˜å¯ä»¥å†åƒä¸€ç‚¹å“¦~</div>
    <div class="camera-btn" id="cameraMainBtn">
        <span>ğŸ“¸</span> æ‹ç…§è®°å½•
    </div>
</div>

<!-- ä»Šæ—¥é£Ÿç‰©åˆ—è¡¨æ ‡é¢˜ -->
<div class="section-title" id="currentDateTitle">ğŸ½ï¸ ä»Šå¤© Â· <span id="dateString"></span></div>
<div class="food-list" id="foodListContainer"></div>

<!-- ========= å¼¹çª—1ï¼šæ‹ç…§/é€‰å›¾ ========= -->
<div class="modal" id="modalPickImage">
    <div class="modal-content" style="text-align: center;">
        <div class="modal-title">ğŸ“· æ·»åŠ é£Ÿç‰©ç…§ç‰‡</div>
        <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
            <button class="btn-small" id="takePhotoBtn">ğŸ“¸ æ‹ç…§</button>
            <button class="btn-small" id="uploadPhotoBtn">ğŸ–¼ï¸ ä»ç›¸å†Œé€‰</button>
        </div>
        <div><button class="btn-secondary btn" id="closePickModal">å–æ¶ˆ</button></div>
    </div>
</div>

<!-- ========= å¼¹çª—2ï¼šç¼–è¾‘/æ·»åŠ é£Ÿç‰©è¯¦æƒ… ========= -->
<div class="modal" id="modalFoodDetail">
    <div class="modal-content">
        <div class="modal-title" id="detailModalTitle">ğŸ¥— å¡«å†™é£Ÿç‰©</div>
        
        <!-- ç…§ç‰‡é¢„è§ˆ -->
        <div style="display: flex; justify-content: center; margin-bottom: 10px;">
            <div class="food-img" id="previewImage" style="width:100px; height:100px; font-size:48px;">ğŸ²</div>
        </div>

        <!-- é£Ÿç‰©åç§° æ‰‹åŠ¨è¾“å…¥æˆ–é€‰æ‹©é¢„åˆ¶ -->
        <input type="text" class="input-field" id="foodNameInput" placeholder="é£Ÿç‰©åç§°, å¦‚: ç±³é¥­" autocomplete="off">

        <!-- å¿«é€Ÿé€‰æ‹©é¢„åˆ¶é£Ÿç‰© (åˆ†ç±»æ˜¾ç¤º) -->
        <div style="font-size: 16px; margin: 5px 0;">ğŸš å¸¸è§é£Ÿç‰© (æ¯200g)</div>
        <div class="food-selector" id="prefoodList">
            <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±»é£Ÿç‰© -->
        </div>

        <!-- å…‹æ•° + è‡ªåŠ¨è®¡ç®—å¡è·¯é‡Œ -->
        <div class="row-2col">
            <input type="number" class="input-field" id="gramInput" value="200" placeholder="å…‹æ•°" min="1">
            <div style="display: flex; align-items: center; background: #ffeeee; border-radius: 60px; padding: 0 15px; font-weight: 600; color: #a34e4e;" id="calDisplay">0 å¤§å¡</div>
        </div>

        <!-- å¤‡æ³¨ -->
        <input type="text" class="input-field" id="remarkInput" placeholder="å¤‡æ³¨ (éå¿…å¡«)">

        <!-- æ·»åŠ æ–°é£Ÿç‰©å°å·¥å…· (æ”¶ç¼©) -->
        <details style="margin: 15px 0;">
            <summary style="color:#b76262;">â• æ·»åŠ æ–°é£Ÿç‰©åˆ°åˆ—è¡¨</summary>
            <div style="background: #fff2f2; padding: 15px; border-radius: 30px; margin-top: 8px;">
                <input type="text" class="input-field" id="newFoodName" placeholder="é£Ÿç‰©å" style="margin-bottom: 8px;">
                <div class="row-2col">
                    <input type="number" class="input-field" id="newFoodCal" placeholder="æ¯100gå¡è·¯é‡Œ" style="margin-bottom: 0;">
                    <select class="input-field" id="newFoodCategory">
                        <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option><option value="æ°´æœ">æ°´æœ</option><option value="è‚‰ç±»">è‚‰ç±»</option>
                        <option value="è”¬èœ">è”¬èœ</option><option value="é¥®å“">é¥®å“</option><option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <button class="btn-small" id="addNewFoodBtn" style="width:100%;">ä¿å­˜æ–°é£Ÿç‰©</button>
            </div>
        </details>

        <!-- éšè—IDï¼Œç”¨äºç¼–è¾‘ -->
        <input type="hidden" id="editRecordId" value="">

        <div class="btn-group">
            <button class="btn btn-secondary" id="cancelDetailBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveFoodDetailBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- ========= å¼¹çª—3ï¼šæ—¥å†è§†å›¾ ========= -->
<div class="modal" id="modalCalendar">
    <div class="modal-content">
        <div class="modal-title">ğŸ“† é¥®é£Ÿæ—¥å†</div>
        
        <!-- æ—¥å†å¯¼èˆª -->
        <div class="calendar-header">
            <button class="calendar-nav-btn" id="prevMonthBtn">â—€</button>
            <span class="calendar-month" id="calendarMonthYear">2024å¹´1æœˆ</span>
            <button class="calendar-nav-btn" id="nextMonthBtn">â–¶</button>
        </div>
        
        <!-- æ˜ŸæœŸ -->
        <div class="weekdays">
            <div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div>
        </div>
        
        <!-- æ—¥å†ç½‘æ ¼ -->
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn btn-secondary" id="closeCalendarBtn">è¿”å›ä»Šå¤©</button>
        </div>
    </div>
</div>

<!-- ========= å¼¹çª—4ï¼šç¡®è®¤åˆ é™¤ ========= -->
<div class="modal" id="modalDeleteConfirm">
    <div class="modal-content confirm-box">
        <div class="modal-title" style="justify-content:center;">ğŸ§ ç¡®å®šåˆ é™¤ï¼Ÿ</div>
        <div style="margin: 20px 0;">åˆ é™¤åä¸å¯æ¢å¤</div>
        <div class="btn-group">
            <button class="btn btn-secondary" id="cancelDeleteBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="confirmDeleteBtn">åˆ é™¤</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- æ•°æ®å­˜å‚¨ ----------
        const STORAGE_KEY = 'picasso_diary_meals';
        const PREFOOD_KEY = 'picasso_custom_foods';

        // é»˜è®¤é¢„åˆ¶é£Ÿç‰© (æ¯200gå¡è·¯é‡Œ)
        const defaultPreFoods = [
            { name:'ç±³é¥­', calPer200:232, category:'ä¸»é£Ÿ' },
            { name:'é¢æ¡', calPer200:274, category:'ä¸»é£Ÿ' },
            { name:'è‹¹æœ', calPer200:104, category:'æ°´æœ' },
            { name:'é¦™è•‰', calPer200:178, category:'æ°´æœ' },
            { name:'é¸¡èƒ¸è‚‰', calPer200:330, category:'è‚‰ç±»' },
            { name:'é¸¡è›‹', calPer200:310, category:'è‚‰ç±»' },
            { name:'ç‰›å¥¶', calPer200:108, category:'é¥®å“' },
            { name:'è¥¿å…°èŠ±', calPer200:68, category:'è”¬èœ' },
            { name:'ç‰›è‚‰', calPer200:500, category:'è‚‰ç±»' },
            { name:'çŒªè‚‰', calPer200:542, category:'è‚‰ç±»' }
        ];

        // åŠ è½½è‡ªå®šä¹‰é£Ÿç‰©
        function loadPreFoods() {
            let stored = localStorage.getItem(PREFOOD_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {}
            }
            return defaultPreFoods;
        }
        function savePreFoods(foods) {
            localStorage.setItem(PREFOOD_KEY, JSON.stringify(foods));
        }

        // æ‰€æœ‰è®°å½•
        function loadMeals() {
            let stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {}
            }
            return [];
        }
        function saveMeals(meals) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(meals));
        }

        // å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸ
        let currentDisplayDate = new Date().toISOString().slice(0,10);
        let preFoods = loadPreFoods();
        let pendingDeleteId = null;
        let currentImageEmoji = 'ğŸ²';
        
        // æ—¥å†å½“å‰å¹´æœˆ
        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth();

        // ---------- è¾…åŠ©å‡½æ•° ----------
        function formatDate(dateStr) {
            if (!dateStr) return '';
            let [y,m,d] = dateStr.split('-');
            return `${y}å¹´${m}æœˆ${d}æ—¥`;
        }

        // è·å–æŒ‡å®šæ—¥æœŸçš„æ€»å¡è·¯é‡Œ
        function getTotalCalByDate(date) {
            let meals = loadMeals();
            return meals.filter(m => m.date === date).reduce((acc, cur) => acc + (cur.calories || 0), 0);
        }

        // æ ¹æ®å¡è·¯é‡Œæ›´æ–°å¡ç‰‡æ ·å¼å’Œæç¤º
        function updateCalorieCardStyle(total) {
            let card = document.getElementById('calorieCard');
            let warningDiv = document.getElementById('warningMessage');
            
            card.classList.remove('green', 'yellow', 'red');
            
            if (total <= 1200) {
                card.classList.add('green');
                warningDiv.innerText = 'âœ¨ è¿˜å¯ä»¥å†åƒä¸€ç‚¹å“¦~';
            } else if (total <= 1500) {
                card.classList.add('yellow');
                warningDiv.innerText = 'âš ï¸ æˆ‘åŠä½ ä¸è¦å†åƒäº†';
            } else {
                card.classList.add('red');
                warningDiv.innerText = 'ğŸ’¢ å…„å¼Ÿï¼Œä½ åƒå¤ªå¤šäº†ï¼Œä½ æ˜¯çŒªå—ï¼Ÿ';
            }
        }

        // åˆ·æ–°ä¸»ç•Œé¢
        function refreshUI() {
            document.getElementById('dateString').innerText = formatDate(currentDisplayDate);

            let meals = loadMeals().filter(m => m.date === currentDisplayDate).sort((a,b) => (a.timestamp||0) - (b.timestamp||0));
            let total = meals.reduce((acc, m) => acc + (m.calories || 0), 0);
            document.getElementById('totalCalDisplay').innerHTML = `${total} å¤§å¡ <span>ç›®æ ‡1500</span>`;

            updateCalorieCardStyle(total);

            let container = document.getElementById('foodListContainer');
            if (meals.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#bba5a5; padding:40px 0;">âœ¨ ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•ï¼Œæ‹ç…§æ·»åŠ å§</div>';
                return;
            }

            let html = '';
            meals.forEach(m => {
                let imgHtml = m.imageEmoji ? m.imageEmoji : 'ğŸ½ï¸';
                let remarkHtml = m.remark ? `<div class="food-remark">ğŸ“ ${m.remark}</div>` : '';
                html += `
                    <div class="food-item" data-id="${m.id}">
                        <div class="food-img">${imgHtml}</div>
                        <div class="food-info">
                            <div class="food-name">${m.name} Â· ${m.grams}g</div>
                            <div class="food-cal">${m.calories} å¤§å¡</div>
                            ${remarkHtml}
                        </div>
                        <button class="delete-btn" data-id="${m.id}" data-action="delete">ğŸ—‘ï¸</button>
                    </div>
                `;
            });
            container.innerHTML = html;

            document.querySelectorAll('.food-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.closest('[data-action="delete"]')) return;
                    let id = this.dataset.id;
                    let meals = loadMeals();
                    let record = meals.find(r => r.id === id);
                    if (record) {
                        openDetailModal(record);
                    }
                });
            });

            document.querySelectorAll('[data-action="delete"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    let id = this.dataset.id;
                    pendingDeleteId = id;
                    document.getElementById('modalDeleteConfirm').style.display = 'flex';
                });
            });
        }

        // æ‰“å¼€è¯¦æƒ…å¼¹çª—
        function openDetailModal(record = null) {
            let modal = document.getElementById('modalFoodDetail');
            let preview = document.getElementById('previewImage');
            document.getElementById('foodNameInput').value = record ? record.name : '';
            document.getElementById('gramInput').value = record ? record.grams : 200;
            document.getElementById('remarkInput').value = record ? (record.remark || '') : '';
            document.getElementById('editRecordId').value = record ? record.id : '';
            if (record && record.imageEmoji) {
                preview.innerText = record.imageEmoji;
                currentImageEmoji = record.imageEmoji;
            } else {
                preview.innerText = currentImageEmoji || 'ğŸ²';
            }
            updateCalDisplay();
            modal.style.display = 'flex';
        }

        function updateCalDisplay() {
            let name = document.getElementById('foodNameInput').value.trim();
            let grams = parseFloat(document.getElementById('gramInput').value) || 0;
            let cal = 0;
            if (name && grams > 0) {
                let matched = preFoods.find(f => f.name === name);
                if (matched) {
                    cal = Math.round((matched.calPer200 / 200) * grams);
                } else {
                    cal = Math.round(grams * 1.0); 
                }
            }
            document.getElementById('calDisplay').innerText = cal + ' å¤§å¡';
        }

        function renderPreFoodsInModal() {
            let container = document.getElementById('prefoodList');
            let categories = ['ä¸»é£Ÿ','æ°´æœ','è‚‰ç±»','è”¬èœ','é¥®å“','å…¶ä»–'];
            let html = '';
            categories.forEach(cat => {
                let foodsInCat = preFoods.filter(f => f.category === cat);
                if (foodsInCat.length) {
                    html += `<div class="category-title">${cat}</div>`;
                    foodsInCat.forEach(f => {
                        html += `<div class="food-tag" data-name="${f.name}" data-cal200="${f.calPer200}">${f.name} <span style="font-size:11px;">${f.calPer200}å¤§å¡/200g</span></div>`;
                    });
                }
            });
            container.innerHTML = html;
            document.querySelectorAll('.food-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    let fname = this.dataset.name;
                    document.getElementById('foodNameInput').value = fname;
                    updateCalDisplay();
                });
            });
        }

        function setRandomFoodEmoji() {
            let emojis = ['ğŸ','ğŸš','ğŸŒ','ğŸ¥©','ğŸ¥›','ğŸ¥¦','ğŸœ','ğŸ—','ğŸ¥‘','ğŸ³','ğŸ¥','ğŸ•'];
            currentImageEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            document.getElementById('previewImage').innerText = currentImageEmoji;
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            let grid = document.getElementById('calendarGrid');
            let monthYearDisplay = document.getElementById('calendarMonthYear');
            
            let firstDay = new Date(calendarYear, calendarMonth, 1);
            let startDayOfWeek = firstDay.getDay(); // 0 = å‘¨æ—¥
            // è°ƒæ•´æˆå‘¨ä¸€ä¸ºä¸€å‘¨å¼€å§‹ (0=å‘¨ä¸€, 6=å‘¨æ—¥)
            startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
            
            let daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
            
            monthYearDisplay.innerText = `${calendarYear}å¹´${calendarMonth + 1}æœˆ`;
            
            let html = '';
            // å¡«å……å‰é¢çš„ç©ºæ ¼
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // è·å–å½“æœˆæ‰€æœ‰æ—¥æœŸçš„æ€»å¡è·¯é‡Œ
            let meals = loadMeals();
            let dailyCal = {};
            meals.forEach(m => {
                if (m.date.startsWith(`${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}`)) {
                    dailyCal[m.date] = (dailyCal[m.date] || 0) + m.calories;
                }
            });
            
            // å¡«å……æ—¥æœŸ
            for (let d = 1; d <= daysInMonth; d++) {
                let dateStr = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let cal = dailyCal[dateStr] || 0;
                
                // æ ¹æ®çƒ­é‡æ·»åŠ æ ·å¼ç±»
                let calClass = '';
                if (cal > 0) {
                    if (cal <= 1200) calClass = 'cal-low';
                    else if (cal <= 1500) calClass = 'cal-mid';
                    else calClass = 'cal-high';
                }
                
                let isSelected = (dateStr === currentDisplayDate) ? 'selected' : '';
                
                html += `
                    <div class="calendar-day ${calClass} ${isSelected}" data-date="${dateStr}">
                        <span class="day-number">${d}</span>
                        ${cal > 0 ? `<span class="day-calories">${cal}</span>` : ''}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.addEventListener('click', function() {
                    let selectedDate = this.dataset.date;
                    currentDisplayDate = selectedDate;
                    document.getElementById('modalCalendar').style.display = 'none';
                    refreshUI();
                });
            });
        }

        // åˆå§‹åŒ–
        function init() {
            renderPreFoodsInModal();

            document.getElementById('foodNameInput').addEventListener('input', updateCalDisplay);
            document.getElementById('gramInput').addEventListener('input', updateCalDisplay);

            // æ‹ç…§ä¸»æŒ‰é’®
            document.getElementById('cameraMainBtn').addEventListener('click', ()=>{
                document.getElementById('modalPickImage').style.display = 'flex';
            });

            document.getElementById('takePhotoBtn').addEventListener('click', ()=>{
                setRandomFoodEmoji();
                document.getElementById('modalPickImage').style.display = 'none';
                openDetailModal();
            });
            document.getElementById('uploadPhotoBtn').addEventListener('click', ()=>{
                setRandomFoodEmoji();
                document.getElementById('modalPickImage').style.display = 'none';
                openDetailModal();
            });
            document.getElementById('closePickModal').addEventListener('click', ()=>{
                document.getElementById('modalPickImage').style.display = 'none';
            });

            document.getElementById('cancelDetailBtn').addEventListener('click', ()=>{
                document.getElementById('modalFoodDetail').style.display = 'none';
            });

            document.getElementById('saveFoodDetailBtn').addEventListener('click', ()=>{
                let id = document.getElementById('editRecordId').value;
                let name = document.getElementById('foodNameInput').value.trim();
                let grams = parseFloat(document.getElementById('gramInput').value) || 0;
                let remark = document.getElementById('remarkInput').value.trim();
                let calText = document.getElementById('calDisplay').innerText;
                let calories = parseInt(calText) || 0;
                if (!name || grams <= 0) {
                    alert('è¯·å¡«å†™é£Ÿç‰©åç§°å’Œå…‹æ•°');
                    return;
                }

                let meals = loadMeals();
                let now = Date.now();
                let imageEmoji = currentImageEmoji || 'ğŸ½ï¸';

                if (id) {
                    let index = meals.findIndex(m => m.id === id);
                    if (index !== -1) {
                        meals[index] = { ...meals[index], name, grams, calories, remark, imageEmoji, timestamp: now };
                    }
                } else {
                    let newRecord = {
                        id: 'm_' + now + '_' + Math.random().toString(36).substr(2, 6),
                        date: currentDisplayDate,
                        name, grams, calories, remark, imageEmoji,
                        timestamp: now
                    };
                    meals.push(newRecord);
                }
                saveMeals(meals);
                document.getElementById('modalFoodDetail').style.display = 'none';
                refreshUI();
            });

            document.getElementById('addNewFoodBtn').addEventListener('click', ()=>{
                let newName = document.getElementById('newFoodName').value.trim();
                let newCal = parseFloat(document.getElementById('newFoodCal').value);
                let category = document.getElementById('newFoodCategory').value;
                if (!newName || isNaN(newCal) || newCal <= 0) {
                    alert('è¯·å¡«å†™å®Œæ•´');
                    return;
                }
                let calPer200 = Math.round(newCal * 2);
                preFoods.push({ name: newName, calPer200, category });
                savePreFoods(preFoods);
                renderPreFoodsInModal();
                document.getElementById('newFoodName').value = '';
                document.getElementById('newFoodCal').value = '';
                alert('âœ… æ–°é£Ÿç‰©å·²æ·»åŠ ');
            });

            // æ—¥å†
            document.getElementById('calendarBtn').addEventListener('click', ()=>{
                document.getElementById('modalCalendar').style.display = 'flex';
                renderCalendar();
            });

            document.getElementById('prevMonthBtn').addEventListener('click', ()=>{
                if (calendarMonth === 0) {
                    calendarYear--;
                    calendarMonth = 11;
                } else {
                    calendarMonth--;
                }
                renderCalendar();
            });

            document.getElementById('nextMonthBtn').addEventListener('click', ()=>{
                if (calendarMonth === 11) {
                    calendarYear++;
                    calendarMonth = 0;
                } else {
                    calendarMonth++;
                }
                renderCalendar();
            });

            document.getElementById('closeCalendarBtn').addEventListener('click', ()=>{
                document.getElementById('modalCalendar').style.display = 'none';
                currentDisplayDate = new Date().toISOString().slice(0,10);
                refreshUI();
            });

            // åˆ é™¤ç¡®è®¤
            document.getElementById('cancelDeleteBtn').addEventListener('click', ()=>{
                document.getElementById('modalDeleteConfirm').style.display = 'none';
                pendingDeleteId = null;
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
                if (pendingDeleteId) {
                    let meals = loadMeals();
                    meals = meals.filter(m => m.id !== pendingDeleteId);
                    saveMeals(meals);
                    refreshUI();
                }
                document.getElementById('modalDeleteConfirm').style.display = 'none';
                pendingDeleteId = null;
            });

            window.addEventListener('click', (e)=>{
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            refreshUI();
        }

        window.onload = init;
    })();
</script>
</body>
</html>